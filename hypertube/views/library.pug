extends layout

block style
    style.
        .movie span.badge {
            width: 45%
            font-size: 20px
        }
        .movie span.badge.right {
            float: right
        }

block content
    .container.mt-4
        .row
            .col-md-12
                .card
                    .card-body
                        h2 #{__('Search a movie or tv show')}
                        hr

                        form(method='post', action='/search', data-ajax, data-ajax-callback='afterSearch')
                            .form-group
                                input.form-control(type='text', name='query')
                            button.btn.btn-primary(type='submit') #{__('Find')}
                .row.results
        hr
        h2 #{__('Library')}
        | // TODO: ORDER / FILTER
        .row.mt-2#content


block scripts
    script#template(type='text/html').
        <div class="col-md-4 mt-3 hidden">
            <div class="card movie" {STYLE}>
                {IMG}
                <div class="card-body">
                    <h5 class="card-title">{NAME}</h5>
                    <p class="card-text">{OVERVIEW}</p>
                    <hr>
                    <span class="badge badge-info">{VOTE_AVERAGE} / 10</span>
                    <span class="badge badge-info right">{DATE}</span>
                    <hr>
                    <a class="btn btn-primary btn-block" href="/{NAME}">{VIEW_BTN}</a>
                </div>
            </div>
        </div>
    script(type='text/javascript').
        function generateMovieHTML(movie) {
          var html = $('#template').html()
          html = html.replace(/{NAME}/g, movie.title)
          html = html.replace('{IMG}', movie.poster_path ? '<img class="card-img-top" src="http://image.tmdb.org/t/p/w780' + movie.poster_path + '">' : '')
          html = html.replace('{OVERVIEW}', movie.overview.substr(0, movie.overview.indexOf('.')))
          html = html.replace('{VIEW_BTN}', movie.media_type === 'movie' ? '#{__('View the movie')}' : '#{__('View the tv show')}')
          html = html.replace('{DATE}', new Date(movie.date).getFullYear())
          html = html.replace('{VOTE_AVERAGE}', movie.vote_average)
          html = html.replace('{STYLE}', movie.viewed ? 'style="opacity:0.6"' : '')
          return html
        }

        var afterSearch = function (req, res) {
          var content = ''
          var results = res.results;

          for (var i = 0; i < results.length; i++) {
            if (!results[i])
              continue
            content += generateMovieHTML(results[i])
          }
          $('.results').html(content)
        }

        var offset = 0
        var content = $('#content')
        var deviceAgent = navigator.userAgent.toLowerCase()
        var agentID = deviceAgent.match(/(iphone|ipod|ipad)/)
        var isEnd = false

        var loadContent = function () {
          $.get('/library/6/' + offset, function (res) {
            var data = ''

            if (res.movies.length === 0) {
              isEnd = true
              return
            }
            for (var i = 0; i < res.movies.length; i++)
              data += generateMovieHTML(res.movies[i])
            content.append(data)
            content.find('.hidden').fadeIn(400)
            offset += 6
          })
        }
        loadContent()
        $(window).scroll(function () {
          if (isEnd)
            return
          if (($(window).scrollTop() + $(window).height()) === $(document).height() || agentID && ($(window).scrollTop() + $(window).height()) + 150 > $(document).height()) {
            loadContent()
          }
        })
